import numpy


class Delivery:

    def __init__(self, tempo, warehouse):
        self.warehouse = warehouse
        self.tempo = tempo

    def generate_wait_period(self):
        return numpy.random.exponential(4)/self.tempo  # losowa z rozkładu wykładniczego

    def generate_delivery_size(self):
        return numpy.random.randint(1, 5)

    def run(self):
        while True:
            period = self.generate_wait_period()
            yield self.warehouse.envi.timeout(period)
            new_items = self.generate_delivery_size()
            new_items += self.warehouse.delivery_queue
            self.warehouse.delivery_queue = 0

            if (self.warehouse.items_stored + new_items) <= self.warehouse.capacity:
                print(self.warehouse.envi.now, " Nowa dostawa: ", new_items, "towarów")
                for i in range(1, new_items + 1):
                    for emp in self.warehouse.list_of_employees:
                        if not emp.is_busy:
                            # emp.take_delivery()
                            print(self.warehouse.envi.now, " Pracownik ", emp.employee_id, " odbiera towar")
                            self.warehouse.envi.process(emp.take_delivery())
                            break

                self.warehouse.items_stored += new_items

            else:
                free_space = self.warehouse.capacity - self.warehouse.items_stored
                print(self.warehouse.envi.now, " ", new_items, " towarow w nowej dostawie, ale brak miejsca na przyjecie wszystkich!")
                for i in range(1, free_space + 1):
                    for emp in self.warehouse.list_of_employees:
                        if not emp.is_busy:
                            # emp.take_delivery()
                            print(self.warehouse.envi.now, " Pracownik ", emp.employee_id, " odbiera towar")
                            self.warehouse.envi.process(emp.take_delivery())
                            break

                new_items -= free_space
                self.warehouse.items_stored = self.warehouse.capacity
                self.warehouse.delivery_queue += new_items
                print(self.warehouse.envi.now, " ", self.warehouse.delivery_queue, " zamówień w kolejce do odbioru\n")
